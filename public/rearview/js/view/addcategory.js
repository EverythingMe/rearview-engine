define(["view/base","model/dashboard","collection/monitor","jquery-validate"],function(e,t,i){var s=e.extend({events:{"click .saveCloseCategory":"checkValidationClose","click .saveCategory":"checkValidation","hidden #addCategory":"_cleanUp","shown #addCategory":"focusFirst"},subscriptions:{"view:dashboard:add":"_openModal"},initialize:function(e){_.bindAll(this),this.user=e.user,this.templar=e.templar,Handlebars.registerHelper("toUpperCase",function(e){return"string"==typeof e?e.toUpperCase():e})},render:function(e){this.dashboard=e?e.dashboard:null,this.templar.render({path:"addcategory",el:this.$el,data:e?e:{}}),this.setElement(this.$el),this.setAddCategoryValidation(),this.$modal=this.$el.find(".add-category"),this.resizeModal($("#addCategory"),"small",!0)},setAddCategoryValidation:function(){this.form=$("#addCategoryForm"),this.validator=this.form.validate({rules:{categoryName:{required:!0}},highlight:function(e){$(e).closest(".control-group").addClass("error")},success:function(e){e.closest(".control-group").removeClass("error"),$(e).remove()},submitHandler:function(){this.close?this.saveFinish():this.save()}.bind(this)})},checkValidation:function(){this.close=!1,this.form.submit()},checkValidationClose:function(){this.close=!0,this.form.submit()},save:function(){this._saveCategory(function(){this._cleanUp()}.bind(this))},saveFinish:function(){this._saveCategory(function(){this._closeModal()}.bind(this))},updateMonitorOrder:function(e){var t=this.user.get("preferences");t.dashboards[this.dashboard.id]&&(t.dashboards[e.get("id")]=t.dashboards[this.dashboard.id],t.dashboards[this.dashboard.id]=null,this.user.save())},destructor:function(){var e=this.$el.prev();this.remove(),this.off(),this.$el=$("<section class='add-category-wrap'></section>").insertAfter(e)},_checkFirstCategoryCondition:function(e){new t({id:this.dashboard.id}).fetch({success:function(t){_.isFunction(e)&&e(t)}.bind(this)})},_moveAllCurrentMonitorsToCategory:function(){this.model.save({userId:this.user.get("id"),name:this.$el.find("#categoryName").val(),description:this.$el.find("#categoryDescription").val()},{success:function(e){Backbone.Mediator.pub("view:addcategory:save",{model:e,message:"The category '"+e.get("name")+"' was added.",attention:"Category Saved!"}),e.get("id")&&new i(null,{dashboardId:this.dashboard.id,cb:function(t){t.each(function(t){t.save({dashboardId:e.get("id")})},this),this.updateMonitorOrder(e)}.bind(this)})}.bind(this),error:function(){this.validator.showErrors({categoryName:"That category name already exists!"})}.bind(this)})},_saveCategory:function(e){this._checkFirstCategoryCondition(function(i){this.model=new t({category:!0,dashboardId:this.dashboard.id}),i.get("children").length?this.model.save({userId:this.user.get("id"),name:this.$el.find("#categoryName").val(),description:this.$el.find("#categoryDescription").val()},{success:function(t){Backbone.Mediator.pub("view:addcategory:save",{model:t,message:"The category '"+t.get("name")+"' was added.",attention:"Category Saved!"}),_.isFunction(e)&&e()}.bind(this),error:function(){this.validator.showErrors({categoryName:"That category name already exists!"})}.bind(this)}):(this._moveAllCurrentMonitorsToCategory(),_.isFunction(e)&&e())}.bind(this))},_closeModal:function(){this._cleanUp(),this.$modal.modal("hide")},_cleanUp:function(){this.$el.find("#categoryName").val(""),this.$el.find("#categoryDescription").val(""),this.$el.find("#categoryName").parent().removeClass("error"),this.validator.resetForm(),this.model=new t},_openModal:function(e){this.destructor(),this.render(e),this.$modal.modal("show")}});return s});